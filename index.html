import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime, timedelta
import io
import base64
from flask import Flask, render_template, request, redirect, url_for, send_file, flash, session, jsonify
import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
import os
from werkzeug.utils import secure_filename
from werkzeug.security import generate_password_hash, check_password_hash
from functools import wraps
import sqlite3
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split
import random
import time
from threading import Thread
import schedule
import pdfkit
from jinja2 import Environment, FileSystemLoader

# Create the app
app = Flask(__name__)
app.secret_key = 'crispy_chicken_advanced_secret_key'

# File upload settings
UPLOAD_FOLDER = 'uploads'
ALLOWED_EXTENSIONS = {'xlsx', 'xls'}
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

# Ensure necessary folders exist
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
os.makedirs('static/reports', exist_ok=True)
os.makedirs('templates', exist_ok=True)

# Initialize database
def init_db():
    conn = sqlite3.connect('crispy_chicken.db')
    cursor = conn.cursor()
    
    # Users table
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE NOT NULL,
        password TEXT NOT NULL,
        role TEXT NOT NULL,
        name TEXT NOT NULL
    )
    ''')
    
    # Targets table
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS targets (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        branch TEXT NOT NULL,
        target_value REAL NOT NULL,
        target_type TEXT NOT NULL,
        period TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
    ''')
    
    # Add default user if not exists
    cursor.execute("SELECT * FROM users WHERE username = 'admin'")
    if cursor.fetchone() is None:
        hashed_password = generate_password_hash('admin123')
        cursor.execute("INSERT INTO users (username, password, role, name) VALUES (?, ?, ?, ?)",
                      ('admin', hashed_password, 'admin', 'System Administrator'))
    
    conn.commit()
    conn.close()

init_db()

# Login check decorator
def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'logged_in' not in session:
            flash('You must login first', 'danger')
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

# Admin check decorator
def admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'role' not in session or session['role'] != 'admin':
            flash('You do not have permission to access this page', 'danger')
            return redirect(url_for('index'))
        return f(*args, **kwargs)
    return decorated_function

# Load initial data
def load_initial_data():
    # Create dummy data based on description
    data = {
        'Date': pd.date_range(start='2025-10-01', end='2025-10-09').repeat(5),
        'Branch': np.repeat(['Hamdan St', 'City Mall', 'Airport Road', 'Corniche', 'Al Zahia'], 9),
        'Channel': ['Delivery'] * 45,
        'Transactions': np.random.randint(50, 200, 45),
        'Sales (AED)': np.random.randint(5000, 20000, 45)
    }
    df = pd.DataFrame(data)
    return df

# Load data
df = load_initial_data()

# Check file extension
def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

# Simulate real-time updates
def simulate_realtime_updates():
    while True:
        time.sleep(10)  # Update every 10 seconds
        # Add new random data
        global df
        new_date = datetime.now().strftime('%Y-%m-%d')
        branches = ['Hamdan St', 'City Mall', 'Airport Road', 'Corniche', 'Al Zahia']
        branch = random.choice(branches)
        transactions = random.randint(50, 200)
        sales = random.randint(5000, 20000)
        
        new_row = {
            'Date': pd.to_datetime(new_date),
            'Branch': branch,
            'Channel': 'Delivery',
            'Transactions': transactions,
            'Sales (AED)': sales
        }
        
        df = pd.concat([df, pd.DataFrame([new_row])], ignore_index=True)
        
        # Keep only last 100 records
        if len(df) > 100:
            df = df.tail(100).reset_index(drop=True)

# Start real-time updates simulation
update_thread = Thread(target=simulate_realtime_updates)
update_thread.daemon = True
update_thread.start()

# Login page
@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        
        conn = sqlite3.connect('crispy_chicken.db')
        cursor = conn.cursor()
        
        cursor.execute("SELECT * FROM users WHERE username = ?", (username,))
        user = cursor.fetchone()
        conn.close()
        
        if user and check_password_hash(user[2], password):
            session['logged_in'] = True
            session['user_id'] = user[0]
            session['username'] = user[1]
            session['role'] = user[3]
            session['name'] = user[4]
            
            flash('Login successful', 'success')
            return redirect(url_for('index'))
        else:
            flash('Invalid username or password', 'danger')
    
    return render_template('login.html')

# Logout page
@app.route('/logout')
def logout():
    session.clear()
    flash('You have been logged out successfully', 'success')
    return redirect(url_for('login'))

# Home page
@app.route('/')
@login_required
def index():
    # Convert data to HTML
    table_html = df.to_html(classes='table table-striped table-hover', index=False)
    
    # Basic analytics
    total_sales = df['Sales (AED)'].sum()
    total_transactions = df['Transactions'].sum()
    avg_sales_per_transaction = total_sales / total_transactions if total_transactions > 0 else 0
    
    # Best restaurant
    best_restaurant = df.groupby('Branch')['Sales (AED)'].sum().idxmax()
    best_restaurant_sales = df.groupby('Branch')['Sales (AED)'].sum().max()
    
    # Best day
    df['DayOfWeek'] = df['Date'].dt.day_name()
    best_day = df.groupby('DayOfWeek')['Sales (AED)'].sum().idxmax()
    best_day_sales = df.groupby('DayOfWeek')['Sales (AED)'].sum().max()
    
    # Worst restaurant
    worst_restaurant = df.groupby('Branch')['Sales (AED)'].sum().idxmin()
    worst_restaurant_sales = df.groupby('Branch')['Sales (AED)'].sum().min()
    
    # Worst day
    worst_day = df.groupby('DayOfWeek')['Sales (AED)'].sum().idxmin()
    worst_day_sales = df.groupby('DayOfWeek')['Sales (AED)'].sum().min()
    
    # Daily sales chart data
    daily_sales = df.groupby('Date')['Sales (AED)'].sum().reset_index()
    daily_sales['Date'] = daily_sales['Date'].dt.strftime('%Y-%m-%d')
    
    return render_template('index.html', 
                          table=table_html,
                          total_sales=total_sales,
                          total_transactions=total_transactions,
                          avg_sales_per_transaction=avg_sales_per_transaction,
                          best_restaurant=best_restaurant,
                          best_restaurant_sales=best_restaurant_sales,
                          best_day=best_day,
                          best_day_sales=best_day_sales,
                          worst_restaurant=worst_restaurant,
                          worst_restaurant_sales=worst_restaurant_sales,
                          worst_day=worst_day,
                          worst_day_sales=worst_day_sales,
                          daily_sales=daily_sales.to_dict('records'),
                          username=session.get('name', ''),
                          role=session.get('role', ''))

# Detailed analysis page
@app.route('/analysis')
@login_required
def analysis():
    # Branch analytics
    branch_sales = df.groupby('Branch')['Sales (AED)'].sum().sort_values(ascending=False)
    branch_transactions = df.groupby('Branch')['Transactions'].sum().sort_values(ascending=False)
    branch_avg_sales = df.groupby('Branch')['Sales (AED)'].mean().sort_values(ascending=False)
    
    # Day analytics
    df['DayOfWeek'] = df['Date'].dt.day_name()
    day_sales = df.groupby('DayOfWeek')['Sales (AED)'].sum().sort_values(ascending=False)
    day_transactions = df.groupby('DayOfWeek')['Transactions'].sum().sort_values(ascending=False)
    
    # Week analytics
    df['Week'] = df['Date'].dt.isocalendar().week
    week_sales = df.groupby('Week')['Sales (AED)'].sum()
    
    # Month analytics
    df['Month'] = df['Date'].dt.month_name()
    month_sales = df.groupby('Month')['Sales (AED)'].sum()
    
    # Delivery analytics
    delivery_sales = df[df['Channel'] == 'Delivery']['Sales (AED)'].sum()
    delivery_transactions = df[df['Channel'] == 'Delivery']['Transactions'].sum()
    delivery_avg = delivery_sales / delivery_transactions if delivery_transactions > 0 else 0
    
    # Create charts
    # 1. Branch sales chart
    plt.figure(figsize=(12, 6))
    branch_sales.plot(kind='bar', color='skyblue')
    plt.title('Branch Sales (AED)', fontsize=16)
    plt.ylabel('Sales (AED)', fontsize=12)
    plt.xticks(rotation=45)
    plt.tight_layout()
    branch_sales_img = io.BytesIO()
    plt.savefig(branch_sales_img, format='png')
    branch_sales_img.seek(0)
    branch_sales_img_base64 = base64.b64encode(branch_sales_img.getvalue()).decode('utf-8')
    plt.close()
    
    # 2. Day sales chart
    plt.figure(figsize=(12, 6))
    day_sales.plot(kind='bar', color='lightgreen')
    plt.title('Day Sales (AED)', fontsize=16)
    plt.ylabel('Sales (AED)', fontsize=12)
    plt.xticks(rotation=45)
    plt.tight_layout()
    day_sales_img = io.BytesIO()
    plt.savefig(day_sales_img, format='png')
    day_sales_img.seek(0)
    day_sales_img_base64 = base64.b64encode(day_sales_img.getvalue()).decode('utf-8')
    plt.close()
    
    # 3. Branch vs Day comparison chart
    plt.figure(figsize=(14, 8))
    pivot_df = df.pivot_table(values='Sales (AED)', index='Branch', columns='DayOfWeek', aggfunc='sum')
    sns.heatmap(pivot_df, annot=True, fmt='.1f', cmap='YlGnBu', linewidths=.5)
    plt.title('Branch Sales Comparison by Day (AED)', fontsize=16)
    plt.tight_layout()
    heatmap_img = io.BytesIO()
    plt.savefig(heatmap_img, format='png')
    heatmap_img.seek(0)
    heatmap_img_base64 = base64.b64encode(heatmap_img.getvalue()).decode('utf-8')
    plt.close()
    
    # 4. Weekly sales chart
    plt.figure(figsize=(10, 6))
    week_sales.plot(kind='line', marker='o', color='purple')
    plt.title('Weekly Sales (AED)', fontsize=16)
    plt.ylabel('Sales (AED)', fontsize=12)
    plt.xlabel('Week', fontsize=12)
    plt.grid(True)
    plt.tight_layout()
    week_sales_img = io.BytesIO()
    plt.savefig(week_sales_img, format='png')
    week_sales_img.seek(0)
    week_sales_img_base64 = base64.b64encode(week_sales_img.getvalue()).decode('utf-8')
    plt.close()
    
    # 5. Monthly sales chart
    plt.figure(figsize=(10, 6))
    month_sales.plot(kind='pie', autopct='%1.1f%%', startangle=90, colors=sns.color_palette('pastel'))
    plt.title('Monthly Sales Distribution (%)', fontsize=16)
    plt.tight_layout()
    month_sales_img = io.BytesIO()
    plt.savefig(month_sales_img, format='png')
    month_sales_img.seek(0)
    month_sales_img_base64 = base64.b64encode(month_sales_img.getvalue()).decode('utf-8')
    plt.close()
    
    return render_template('analysis.html',
                          branch_sales=branch_sales.to_html(),
                          branch_transactions=branch_transactions.to_html(),
                          branch_avg_sales=branch_avg_sales.to_html(),
                          day_sales=day_sales.to_html(),
                          day_transactions=day_transactions.to_html(),
                          week_sales=week_sales.to_html(),
                          month_sales=month_sales.to_html(),
                          delivery_sales=delivery_sales,
                          delivery_transactions=delivery_transactions,
                          delivery_avg=delivery_avg,
                          branch_sales_img=branch_sales_img_base64,
                          day_sales_img=day_sales_img_base64,
                          heatmap_img=heatmap_img_base64,
                          week_sales_img=week_sales_img_base64,
                          month_sales_img=month_sales_img_base64,
                          username=session.get('name', ''),
                          role=session.get('role', ''))

# Data management page
@app.route('/data', methods=['GET', 'POST'])
@login_required
def data_management():
    if request.method == 'POST':
        # Check if file was uploaded
        if 'file' not in request.files:
            flash('No file selected', 'danger')
            return redirect(request.url)
        
        file = request.files['file']
        
        if file.filename == '':
            flash('No file selected', 'danger')
            return redirect(request.url)
        
        if file and allowed_file(file.filename):
            filename = secure_filename(file.filename)
            filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
            file.save(filepath)
            
            # Read Excel file
            try:
                global df
                df = pd.read_excel(filepath)
                flash(f'Data loaded successfully from {filename}', 'success')
                return redirect(url_for('data_management'))
            except Exception as e:
                flash(f'Error reading file: {str(e)}', 'danger')
                return redirect(request.url)
        else:
            flash('File type not allowed. Please upload an Excel file only', 'danger')
            return redirect(request.url)
    
    # Display data with filtering and pagination
    page = request.args.get('page', 1, type=int)
    per_page = 10
    
    # Filter data
    branch_filter = request.args.get('branch', '')
    date_filter = request.args.get('date', '')
    
    filtered_df = df.copy()
    
    if branch_filter:
        filtered_df = filtered_df[filtered_df['Branch'] == branch_filter]
    
    if date_filter:
        filtered_df = filtered_df[filtered_df['Date'].dt.strftime('%Y-%m-%d') == date_filter]
    
    # Pagination
    total_pages = (len(filtered_df) + per_page - 1) // per_page
    start = (page - 1) * per_page
    end = start + per_page
    paginated_df = filtered_df.iloc[start:end]
    
    table_html = paginated_df.to_html(classes='table table-striped table-hover', index=False)
    
    # Get unique branches
    branches = df['Branch'].unique().tolist()
    
    # Get unique dates
    dates = df['Date'].dt.strftime('%Y-%m-%d').unique().tolist()
    
    return render_template('data.html', 
                          table=table_html,
                          branches=branches,
                          dates=dates,
                          current_branch=branch_filter,
                          current_date=date_filter,
                          page=page,
                          total_pages=total_pages,
                          username=session.get('name', ''),
                          role=session.get('role', ''))

# Add new data
@app.route('/add', methods=['POST'])
@login_required
def add_data():
    date = request.form['date']
    branch = request.form['branch']
    transactions = int(request.form['transactions'])
    sales = int(request.form['sales'])
    
    new_row = {
        'Date': pd.to_datetime(date),
        'Branch': branch,
        'Channel': 'Delivery',
        'Transactions': transactions,
        'Sales (AED)': sales
    }
    
    global df
    df = pd.concat([df, pd.DataFrame([new_row])], ignore_index=True)
    
    flash('Data added successfully', 'success')
    return redirect(url_for('data_management'))

# Delete data
@app.route('/delete/<int:index>')
@login_required
def delete_data(index):
    global df
    df = df.drop(index).reset_index(drop=True)
    flash('Data deleted successfully', 'success')
    return redirect(url_for('data_management'))

# Edit data
@app.route('/edit/<int:index>', methods=['GET', 'POST'])
@login_required
def edit_data(index):
    if request.method == 'POST':
        date = request.form['date']
        branch = request.form['branch']
        transactions = int(request.form['transactions'])
        sales = int(request.form['sales'])
        
        global df
        df.at[index, 'Date'] = pd.to_datetime(date)
        df.at[index, 'Branch'] = branch
        df.at[index, 'Transactions'] = transactions
        df.at[index, 'Sales (AED)'] = sales
        
        flash('Data updated successfully', 'success')
        return redirect(url_for('data_management'))
    
    row = df.iloc[index]
    branches = df['Branch'].unique().tolist()
    
    return render_template('edit.html', 
                          row=row, 
                          index=index, 
                          branches=branches,
                          username=session.get('name', ''),
                          role=session.get('role', ''))

# Download data as Excel file
@app.route('/download')
@login_required
def download_data():
    global df
    output = io.BytesIO()
    writer = pd.ExcelWriter(output, engine='openpyxl')
    df.to_excel(writer, index=False, sheet_name='Sales Data')
    
    # Format the file
    workbook = writer.book
    worksheet = writer.sheets['Sales Data']
    
    # Add formatting to header
    header_font = Font(bold=True, color="FFFFFF", size=12)
    header_fill = PatternFill(start_color="4F81BD", end_color="4F81BD", fill_type="solid")
    thin_border = Border(left=Side(style='thin'), 
                         right=Side(style='thin'), 
                         top=Side(style='thin'), 
                         bottom=Side(style='thin'))
    
    for cell in worksheet[1]:
        cell.font = header_font
        cell.fill = header_fill
        cell.border = thin_border
        cell.alignment = Alignment(horizontal='center')
    
    # Adjust column widths
    for column in worksheet.columns:
        max_length = 0
        column_letter = column[0].column_letter
        for cell in column:
            try:
                if len(str(cell.value)) > max_length:
                    max_length = len(str(cell.value))
            except:
                pass
        adjusted_width = (max_length + 2)
        worksheet.column_dimensions[column_letter].width = adjusted_width
    
    writer.close()
    output.seek(0)
    
    return send_file(output, mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    as_attachment=True, download_name='crispy_chicken_sales_data.xlsx')

# Management report page
@app.route('/report')
@login_required
def management_report():
    # Comprehensive analytics
    total_sales = df['Sales (AED)'].sum()
    total_transactions = df['Transactions'].sum()
    avg_sales_per_transaction = total_sales / total_transactions if total_transactions > 0 else 0
    
    # Best restaurant
    best_restaurant = df.groupby('Branch')['Sales (AED)'].sum().idxmax()
    best_restaurant_sales = df.groupby('Branch')['Sales (AED)'].sum().max()
    
    # Best day
    df['DayOfWeek'] = df['Date'].dt.day_name()
    best_day = df.groupby('DayOfWeek')['Sales (AED)'].sum().idxmax()
    best_day_sales = df.groupby('DayOfWeek')['Sales (AED)'].sum().max()
    
    # Worst restaurant
    worst_restaurant = df.groupby('Branch')['Sales (AED)'].sum().idxmin()
    worst_restaurant_sales = df.groupby('Branch')['Sales (AED)'].sum().min()
    
    # Worst day
    worst_day = df.groupby('DayOfWeek')['Sales (AED)'].sum().idxmin()
    worst_day_sales = df.groupby('DayOfWeek')['Sales (AED)'].sum().min()
    
    # Average sales per branch
    avg_branch_sales = df.groupby('Branch')['Sales (AED)'].mean().sort_values(ascending=False)
    
    # Average sales per day
    avg_day_sales = df.groupby('DayOfWeek')['Sales (AED)'].mean().sort_values(ascending=False)
    
    # Week analytics
    df['Week'] = df['Date'].dt.isocalendar().week
    weekly_sales = df.groupby('Week')['Sales (AED)'].sum()
    
    # Month analytics
    df['Month'] = df['Date'].dt.month_name()
    monthly_sales = df.groupby('Month')['Sales (AED)'].sum()
    
    # Branch contribution percentage to total sales
    branch_contribution = (df.groupby('Branch')['Sales (AED)'].sum() / total_sales * 100).sort_values(ascending=False)
    
    # Create charts
    # 1. Branch sales chart
    plt.figure(figsize=(12, 6))
    df.groupby('Branch')['Sales (AED)'].sum().plot(kind='bar', color='skyblue')
    plt.title('Branch Sales (AED)', fontsize=16)
    plt.ylabel('Sales (AED)', fontsize=12)
    plt.xticks(rotation=45)
    plt.tight_layout()
    branch_sales_img = io.BytesIO()
    plt.savefig(branch_sales_img, format='png')
    branch_sales_img.seek(0)
    branch_sales_img_base64 = base64.b64encode(branch_sales_img.getvalue()).decode('utf-8')
    plt.close()
    
    # 2. Day sales chart
    plt.figure(figsize=(12, 6))
    df.groupby('DayOfWeek')['Sales (AED)'].sum().plot(kind='bar', color='lightgreen')
    plt.title('Day Sales (AED)', fontsize=16)
    plt.ylabel('Sales (AED)', fontsize=12)
    plt.xticks(rotation=45)
    plt.tight_layout()
    day_sales_img = io.BytesIO()
    plt.savefig(day_sales_img, format='png')
    day_sales_img.seek(0)
    day_sales_img_base64 = base64.b64encode(day_sales_img.getvalue()).decode('utf-8')
    plt.close()
    
    # 3. Branch vs Day comparison chart
    plt.figure(figsize=(14, 8))
    pivot_df = df.pivot_table(values='Sales (AED)', index='Branch', columns='DayOfWeek', aggfunc='sum')
    sns.heatmap(pivot_df, annot=True, fmt='.1f', cmap='YlGnBu', linewidths=.5)
    plt.title('Branch Sales Comparison by Day (AED)', fontsize=16)
    plt.tight_layout()
    heatmap_img = io.BytesIO()
    plt.savefig(heatmap_img, format='png')
    heatmap_img.seek(0)
    heatmap_img_base64 = base64.b64encode(heatmap_img.getvalue()).decode('utf-8')
    plt.close()
    
    # 4. Branch contribution chart
    plt.figure(figsize=(10, 8))
    branch_contribution.plot(kind='pie', autopct='%1.1f%%', startangle=90, colors=sns.color_palette('pastel'))
    plt.title('Branch Contribution to Total Sales', fontsize=16)
    plt.tight_layout()
    contribution_img = io.BytesIO()
    plt.savefig(contribution_img, format='png')
    contribution_img.seek(0)
    contribution_img_base64 = base64.b64encode(contribution_img.getvalue()).decode('utf-8')
    plt.close()
    
    return render_template('report.html',
                          total_sales=total_sales,
                          total_transactions=total_transactions,
                          avg_sales_per_transaction=avg_sales_per_transaction,
                          best_restaurant=best_restaurant,
                          best_restaurant_sales=best_restaurant_sales,
                          best_day=best_day,
                          best_day_sales=best_day_sales,
                          worst_restaurant=worst_restaurant,
                          worst_restaurant_sales=worst_restaurant_sales,
                          worst_day=worst_day,
                          worst_day_sales=worst_day_sales,
                          avg_branch_sales=avg_branch_sales.to_html(),
                          avg_day_sales=avg_day_sales.to_html(),
                          weekly_sales=weekly_sales.to_html(),
                          monthly_sales=monthly_sales.to_html(),
                          branch_contribution=branch_contribution.to_html(),
                          branch_sales_img=branch_sales_img_base64,
                          day_sales_img=day_sales_img_base64,
                          heatmap_img=heatmap_img_base64,
                          contribution_img=contribution_img_base64,
                          username=session.get('name', ''),
                          role=session.get('role', ''))

# Target plan page
@app.route('/targets')
@login_required
def target_plan():
    # Calculate current average sales
    current_avg_sales = df.groupby('Branch')['Sales (AED)'].mean()
    
    # Set 20% increase target
    target_increase = 0.2
    target_sales = current_avg_sales * (1 + target_increase)
    
    # Create targets DataFrame
    targets_df = pd.DataFrame({
        'Branch': current_avg_sales.index,
        'Current Average Sales (AED)': current_avg_sales.values,
        'Target Sales (AED)': target_sales.values,
        'Increase Needed (AED)': (target_sales - current_avg_sales).values,
        'Increase Percentage': [target_increase * 100] * len(current_avg_sales)
    })
    
    # Calculate gap between current performance and target
    current_total = df.groupby('Branch')['Sales (AED)'].sum()
    target_total = current_total * (1 + target_increase)
    gap = target_total - current_total
    
    # Create chart
    plt.figure(figsize=(14, 8))
    X_axis = np.arange(len(current_avg_sales.index))
    
    plt.bar(X_axis - 0.2, current_avg_sales.values, 0.4, label='Current', color='skyblue')
    plt.bar(X_axis + 0.2, target_sales.values, 0.4, label='Target', color='lightgreen')
    
    plt.xticks(X_axis, current_avg_sales.index)
    plt.xlabel('Branches', fontsize=12)
    plt.ylabel('Average Sales (AED)', fontsize=12)
    plt.title('Comparison of Current Average Sales with Targets', fontsize=16)
    plt.legend()
    plt.tight_layout()
    
    targets_img = io.BytesIO()
    plt.savefig(targets_img, format='png')
    targets_img.seek(0)
    targets_img_base64 = base64.b64encode(targets_img.getvalue()).decode('utf-8')
    plt.close()
    
    # Gap chart
    plt.figure(figsize=(12, 6))
    gap.plot(kind='bar', color='salmon')
    plt.title('Gap Between Current Sales and Targets (AED)', fontsize=16)
    plt.ylabel('Gap (AED)', fontsize=12)
    plt.xticks(rotation=45)
    plt.tight_layout()
    gap_img = io.BytesIO()
    plt.savefig(gap_img, format='png')
    gap_img.seek(0)
    gap_img_base64 = base64.b64encode(gap_img.getvalue()).decode('utf-8')
    plt.close()
    
    return render_template('targets.html',
                          targets_table=targets_df.to_html(index=False),
                          gap_table=gap.to_html(),
                          targets_img=targets_img_base64,
                          gap_img=gap_img_base64,
                          username=session.get('name', ''),
                          role=session.get('role', ''))

# Branch comparison page
@app.route('/branch-comparison')
@login_required
def branch_comparison():
    # Branch analytics
    branch_sales = df.groupby('Branch')['Sales (AED)'].sum().sort_values(ascending=False)
    branch_transactions = df.groupby('Branch')['Transactions'].sum().sort_values(ascending=False)
    branch_avg_sales = df.groupby('Branch')['Sales (AED)'].mean().sort_values(ascending=False)
    branch_avg_transactions = df.groupby('Branch')['Transactions'].mean().sort_values(ascending=False)
    
    # Create branch comparison chart
    plt.figure(figsize=(14, 8))
    
    # Branch sales
    plt.subplot(2, 2, 1)
    branch_sales.plot(kind='bar', color='skyblue')
    plt.title('Branch Sales (AED)')
    plt.ylabel('Sales (AED)')
    plt.xticks(rotation=45)
    
    # Branch transactions
    plt.subplot(2, 2, 2)
    branch_transactions.plot(kind='bar', color='lightgreen')
    plt.title('Branch Transactions')
    plt.ylabel('Number of Transactions')
    plt.xticks(rotation=45)
    
    # Average branch sales
    plt.subplot(2, 2, 3)
    branch_avg_sales.plot(kind='bar', color='salmon')
    plt.title('Average Branch Sales (AED)')
    plt.ylabel('Average Sales (AED)')
    plt.xticks(rotation=45)
    
    # Average branch transactions
    plt.subplot(2, 2, 4)
    branch_avg_transactions.plot(kind='bar', color='purple')
    plt.title('Average Branch Transactions')
    plt.ylabel('Average Number of Transactions')
    plt.xticks(rotation=45)
    
    plt.tight_layout()
    comparison_img = io.BytesIO()
    plt.savefig(comparison_img, format='png')
    comparison_img.seek(0)
    comparison_img_base64 = base64.b64encode(comparison_img.getvalue()).decode('utf-8')
    plt.close()
    
    return render_template('branch_comparison.html',
                          branch_sales=branch_sales.to_html(),
                          branch_transactions=branch_transactions.to_html(),
                          branch_avg_sales=branch_avg_sales.to_html(),
                          branch_avg_transactions=branch_avg_transactions.to_html(),
                          comparison_img=comparison_img_base64,
                          username=session.get('name', ''),
                          role=session.get('role', ''))

# Daily sales tracking page
@app.route('/daily-sales')
@login_required
def daily_sales():
    # Daily sales analytics
    daily_sales = df.groupby('Date')['Sales (AED)'].sum().reset_index()
    daily_sales['Date'] = daily_sales['Date'].dt.strftime('%Y-%m-%d')
    
    daily_transactions = df.groupby('Date')['Transactions'].sum().reset_index()
    daily_transactions['Date'] = daily_transactions['Date'].dt.strftime('%Y-%m-%d')
    
    # Create daily sales chart
    plt.figure(figsize=(14, 8))
    
    # Daily sales
    plt.subplot(2, 1, 1)
    plt.plot(daily_sales['Date'], daily_sales['Sales (AED)'], marker='o', color='skyblue')
    plt.title('Daily Sales (AED)')
    plt.ylabel('Sales (AED)')
    plt.xticks(rotation=45)
    plt.grid(True)
    
    # Daily transactions
    plt.subplot(2, 1, 2)
    plt.plot(daily_transactions['Date'], daily_transactions['Transactions'], marker='o', color='lightgreen')
    plt.title('Daily Transactions')
    plt.ylabel('Number of Transactions')
    plt.xticks(rotation=45)
    plt.grid(True)
    
    plt.tight_layout()
    daily_sales_img = io.BytesIO()
    plt.savefig(daily_sales_img, format='png')
    daily_sales_img.seek(0)
    daily_sales_img_base64 = base64.b64encode(daily_sales_img.getvalue()).decode('utf-8')
    plt.close()
    
    return render_template('daily_sales.html',
                          daily_sales=daily_sales.to_html(index=False),
                          daily_transactions=daily_transactions.to_html(index=False),
                          daily_sales_img=daily_sales_img_base64,
                          username=session.get('name', ''),
                          role=session.get('role', ''))

# Delivery analysis page
@app.route('/delivery-analysis')
@login_required
def delivery_analysis():
    # Delivery analytics
    delivery_data = df[df['Channel'] == 'Delivery']
    
    # Delivery sales by branch
    delivery_branch_sales = delivery_data.groupby('Branch')['Sales (AED)'].sum().sort_values(ascending=False)
    
    # Delivery transactions by branch
    delivery_branch_transactions = delivery_data.groupby('Branch')['Transactions'].sum().sort_values(ascending=False)
    
    # Average delivery sales by branch
    delivery_branch_avg_sales = delivery_data.groupby('Branch')['Sales (AED)'].mean().sort_values(ascending=False)
    
    # Delivery sales by day
    delivery_data['DayOfWeek'] = delivery_data['Date'].dt.day_name()
    delivery_day_sales = delivery_data.groupby('DayOfWeek')['Sales (AED)'].sum().sort_values(ascending=False)
    
    # Delivery transactions by day
    delivery_day_transactions = delivery_data.groupby('DayOfWeek')['Transactions'].sum().sort_values(ascending=False)
    
    # Create delivery analysis chart
    plt.figure(figsize=(14, 10))
    
    # Delivery sales by branch
    plt.subplot(2, 2, 1)
    delivery_branch_sales.plot(kind='bar', color='skyblue')
    plt.title('Delivery Sales by Branch (AED)')
    plt.ylabel('Sales (AED)')
    plt.xticks(rotation=45)
    
    # Delivery transactions by branch
    plt.subplot(2, 2, 2)
    delivery_branch_transactions.plot(kind='bar', color='lightgreen')
    plt.title('Delivery Transactions by Branch')
    plt.ylabel('Number of Transactions')
    plt.xticks(rotation=45)
    
    # Delivery sales by day
    plt.subplot(2, 2, 3)
    delivery_day_sales.plot(kind='bar', color='salmon')
    plt.title('Delivery Sales by Day (AED)')
    plt.ylabel('Sales (AED)')
    plt.xticks(rotation=45)
    
    # Delivery transactions by day
    plt.subplot(2, 2, 4)
    delivery_day_transactions.plot(kind='bar', color='purple')
    plt.title('Delivery Transactions by Day')
    plt.ylabel('Number of Transactions')
    plt.xticks(rotation=45)
    
    plt.tight_layout()
    delivery_img = io.BytesIO()
    plt.savefig(delivery_img, format='png')
    delivery_img.seek(0)
    delivery_img_base64 = base64.b64encode(delivery_img.getvalue()).decode('utf-8')
    plt.close()
    
    return render_template('delivery_analysis.html',
                          delivery_branch_sales=delivery_branch_sales.to_html(),
                          delivery_branch_transactions=delivery_branch_transactions.to_html(),
                          delivery_branch_avg_sales=delivery_branch_avg_sales.to_html(),
                          delivery_day_sales=delivery_day_sales.to_html(),
                          delivery_day_transactions=delivery_day_transactions.to_html(),
                          delivery_img=delivery_img_base64,
                          username=session.get('name', ''),
                          role=session.get('role', ''))

# Sales forecast page
@app.route('/sales-forecast')
@login_required
def sales_forecast():
    # Prepare data for forecasting
    forecast_data = df.copy()
    forecast_data['Date'] = pd.to_datetime(forecast_data['Date'])
    forecast_data = forecast_data.groupby('Date')['Sales (AED)'].sum().reset_index()
    
    # Convert date to ordinal for use in the model
    forecast_data['DateOrdinal'] = forecast_data['Date'].map(datetime.toordinal)
    
    # Split data
    X = forecast_data[['DateOrdinal']]
    y = forecast_data['Sales (AED)']
    
    # Create linear regression model
    model = LinearRegression()
    model.fit(X, y)
    
    # Forecast sales for the next 7 days
    last_date = forecast_data['Date'].max()
    future_dates = [last_date + timedelta(days=i) for i in range(1, 8)]
    future_ordinals = [[date.toordinal()] for date in future_dates]
    future_sales = model.predict(future_ordinals)
    
    # Create forecast DataFrame
    forecast_df = pd.DataFrame({
        'Date': future_dates,
        'Forecasted Sales (AED)': future_sales
    })
    forecast_df['Date'] = forecast_df['Date'].dt.strftime('%Y-%m-%d')
    
    # Create forecast chart
    plt.figure(figsize=(14, 8))
    
    # Plot actual data
    plt.plot(forecast_data['Date'], forecast_data['Sales (AED)'], 'o-', color='skyblue', label='Actual Data')
    
    # Plot forecasts
    plt.plot(future_dates, future_sales, 'o--', color='red', label='Forecasts')
    
    plt.title('Sales Forecast for Next 7 Days')
    plt.ylabel('Sales (AED)')
    plt.xlabel('Date')
    plt.legend()
    plt.grid(True)
    plt.xticks(rotation=45)
    
    plt.tight_layout()
    forecast_img = io.BytesIO()
    plt.savefig(forecast_img, format='png')
    forecast_img.seek(0)
    forecast_img_base64 = base64.b64encode(forecast_img.getvalue()).decode('utf-8')
    plt.close()
    
    return render_template('sales_forecast.html',
                          forecast_table=forecast_df.to_html(index=False),
                          forecast_img=forecast_img_base64,
                          username=session.get('name', ''),
                          role=session.get('role', ''))

# Target management page
@app.route('/target-management', methods=['GET', 'POST'])
@login_required
@admin_required
def target_management():
    if request.method == 'POST':
        branch = request.form['branch']
        target_value = float(request.form['target_value'])
        target_type = request.form['target_type']
        period = request.form['period']
        
        conn = sqlite3.connect('crispy_chicken.db')
        cursor = conn.cursor()
        
        cursor.execute('''
        INSERT INTO targets (branch, target_value, target_type, period)
        VALUES (?, ?, ?, ?)
        ''', (branch, target_value, target_type, period))
        
        conn.commit()
        conn.close()
        
        flash('Target added successfully', 'success')
        return redirect(url_for('target_management'))
    
    # Get current targets
    conn = sqlite3.connect('crispy_chicken.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM targets ORDER BY created_at DESC')
    targets = cursor.fetchall()
    
    conn.close()
    
    # Get unique branches
    branches = df['Branch'].unique().tolist()
    
    return render_template('target_management.html',
                          targets=targets,
                          branches=branches,
                          username=session.get('name', ''),
                          role=session.get('role', ''))

# Delete target
@app.route('/delete-target/<int:target_id>')
@login_required
@admin_required
def delete_target(target_id):
    conn = sqlite3.connect('crispy_chicken.db')
    cursor = conn.cursor()
    
    cursor.execute('DELETE FROM targets WHERE id = ?', (target_id,))
    
    conn.commit()
    conn.close()
    
    flash('Target deleted successfully', 'success')
    return redirect(url_for('target_management'))

# Generate PDF report page
@app.route('/generate-pdf-report')
@login_required
def generate_pdf_report():
    # Comprehensive analytics
    total_sales = df['Sales (AED)'].sum()
    total_transactions = df['Transactions'].sum()
    avg_sales_per_transaction = total_sales / total_transactions if total_transactions > 0 else 0
    
    # Best restaurant
    best_restaurant = df.groupby('Branch')['Sales (AED)'].sum().idxmax()
    best_restaurant_sales = df.groupby('Branch')['Sales (AED)'].sum().max()
    
    # Best day
    df['DayOfWeek'] = df['Date'].dt.day_name()
    best_day = df.groupby('DayOfWeek')['Sales (AED)'].sum().idxmax()
    best_day_sales = df.groupby('DayOfWeek')['Sales (AED)'].sum().max()
    
    # Worst restaurant
    worst_restaurant = df.groupby('Branch')['Sales (AED)'].sum().idxmin()
    worst_restaurant_sales = df.groupby('Branch')['Sales (AED)'].sum().min()
    
    # Worst day
    worst_day = df.groupby('DayOfWeek')['Sales (AED)'].sum().idxmin()
    worst_day_sales = df.groupby('DayOfWeek')['Sales (AED)'].sum().min()
    
    # Average sales per branch
    avg_branch_sales = df.groupby('Branch')['Sales (AED)'].mean().sort_values(ascending=False)
    
    # Average sales per day
    avg_day_sales = df.groupby('DayOfWeek')['Sales (AED)'].mean().sort_values(ascending=False)
    
    # Week analytics
    df['Week'] = df['Date'].dt.isocalendar().week
    weekly_sales = df.groupby('Week')['Sales (AED)'].sum()
    
    # Month analytics
    df['Month'] = df['Date'].dt.month_name()
    monthly_sales = df.groupby('Month')['Sales (AED)'].sum()
    
    # Branch contribution percentage to total sales
    branch_contribution = (df.groupby('Branch')['Sales (AED)'].sum() / total_sales * 100).sort_values(ascending=False)
    
    # Create charts
    # 1. Branch sales chart
    plt.figure(figsize=(12, 6))
    df.groupby('Branch')['Sales (AED)'].sum().plot(kind='bar', color='skyblue')
    plt.title('Branch Sales (AED)', fontsize=16)
    plt.ylabel('Sales (AED)', fontsize=12)
    plt.xticks(rotation=45)
    plt.tight_layout()
    branch_sales_img = os.path.join('static', 'reports', 'branch_sales.png')
    plt.savefig(branch_sales_img)
    plt.close()
    
    # 2. Day sales chart
    plt.figure(figsize=(12, 6))
    df.groupby('DayOfWeek')['Sales (AED)'].sum().plot(kind='bar', color='lightgreen')
    plt.title('Day Sales (AED)', fontsize=16)
    plt.ylabel('Sales (AED)', fontsize=12)
    plt.xticks(rotation=45)
    plt.tight_layout()
    day_sales_img = os.path.join('static', 'reports', 'day_sales.png')
    plt.savefig(day_sales_img)
    plt.close()
    
    # 3. Branch vs Day comparison chart
    plt.figure(figsize=(14, 8))
    pivot_df = df.pivot_table(values='Sales (AED)', index='Branch', columns='DayOfWeek', aggfunc='sum')
    sns.heatmap(pivot_df, annot=True, fmt='.1f', cmap='YlGnBu', linewidths=.5)
    plt.title('Branch Sales Comparison by Day (AED)', fontsize=16)
    plt.tight_layout()
    heatmap_img = os.path.join('static', 'reports', 'heatmap.png')
    plt.savefig(heatmap_img)
    plt.close()
    
    # 4. Branch contribution chart
    plt.figure(figsize=(10, 8))
    branch_contribution.plot(kind='pie', autopct='%1.1f%%', startangle=90, colors=sns.color_palette('pastel'))
    plt.title('Branch Contribution to Total Sales', fontsize=16)
    plt.tight_layout()
    contribution_img = os.path.join('static', 'reports', 'contribution.png')
    plt.savefig(contribution_img)
    plt.close()
    
    # Set up environment for PDF generation
    env = Environment(loader=FileSystemLoader('.'))
    template = env.from_string('''
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crispy Chicken Restaurant Management Report</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            color: #4F81BD;
            border-bottom: 2px solid #4F81BD;
            padding-bottom: 10px;
        }
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .stat-card {
            width: 48%;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0d6efd;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #6c757d;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .chart {
            text-align: center;
            margin-bottom: 20px;
        }
        .chart img {
            max-width: 100%;
            height: auto;
        }
        .recommendations {
            background-color: #e9f7ef;
            border-radius: 8px;
            padding: 15px;
        }
        .recommendations h3 {
            color: #28a745;
            margin-top: 0;
        }
        .recommendations ul {
            padding-left: 20px;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            font-size: 12px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Crispy Chicken Restaurant Management Report</h1>
        <p>Generation Date: {{ date }}</p>
    </div>
    
    <div class="section">
        <h2>Performance Summary</h2>
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value">{{ "%.2f"|format(total_sales) }}</div>
                <div class="stat-label">Total Sales (AED)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ total_transactions }}</div>
                <div class="stat-label">Total Transactions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ "%.2f"|format(avg_sales_per_transaction) }}</div>
                <div class="stat-label">Average Sales per Transaction</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ best_restaurant }}</div>
                <div class="stat-label">Best Restaurant</div>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>Branch Analysis</h2>
        <table>
            <thead>
                <tr>
                    <th>Branch</th>
                    <th>Average Sales (AED)</th>
                </tr>
            </thead>
            <tbody>
                {% for branch, sales in avg_branch_sales.items() %}
                <tr>
                    <td>{{ branch }}</td>
                    <td>{{ "%.2f"|format(sales) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="section">
        <h2>Day Analysis</h2>
        <table>
            <thead>
                <tr>
                    <th>Day</th>
                    <th>Average Sales (AED)</th>
                </tr>
            </thead>
            <tbody>
                {% for day, sales in avg_day_sales.items() %}
                <tr>
                    <td>{{ day }}</td>
                    <td>{{ "%.2f"|format(sales) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="section">
        <h2>Charts</h2>
        <div class="chart">
            <h3>Branch Sales (AED)</h3>
            <img src="{{ branch_sales_img }}" alt="Branch Sales">
        </div>
        <div class="chart">
            <h3>Day Sales (AED)</h3>
            <img src="{{ day_sales_img }}" alt="Day Sales">
        </div>
        <div class="chart">
            <h3>Branch Sales Comparison by Day (AED)</h3>
            <img src="{{ heatmap_img }}" alt="Branch-Day Comparison">
        </div>
        <div class="chart">
            <h3>Branch Contribution to Total Sales</h3>
            <img src="{{ contribution_img }}" alt="Branch Contribution">
        </div>
    </div>
    
    <div class="section">
        <div class="recommendations">
            <h3>Management Recommendations</h3>
            <ul>
                <li>It is recommended to increase marketing in {{ worst_restaurant }} branch to improve its performance.</li>
                <li>{{ worst_day }} is the weakest sales day, it is recommended to run promotional offers on this day.</li>
                <li>{{ best_restaurant }} branch is the best performer, its strategies can be leveraged in other branches.</li>
                <li>{{ best_day }} is the strongest sales day, it is recommended to increase resources on this day.</li>
            </ul>
        </div>
    </div>
    
    <div class="footer">
        <p>Â© 2025 Crispy Chicken Restaurant Data Analysis System - All Rights Reserved</p>
    </div>
</body>
</html>
    ''')
    
    # Generate HTML
    html = template.render(
        date=datetime.now().strftime('%Y-%m-%d'),
        total_sales=total_sales,
        total_transactions=total_transactions,
        avg_sales_per_transaction=avg_sales_per_transaction,
        best_restaurant=best_restaurant,
        worst_restaurant=worst_restaurant,
        best_day=best_day,
        worst_day=worst_day,
        avg_branch_sales=avg_branch_sales,
        avg_day_sales=avg_day_sales,
        branch_sales_img=branch_sales_img,
        day_sales_img=day_sales_img,
        heatmap_img=heatmap_img,
        contribution_img=contribution_img
    )
    
    # Save HTML as temporary file
    with open('temp_report.html', 'w', encoding='utf-8') as f:
        f.write(html)
    
    # Convert HTML to PDF
    pdf_path = os.path.join('static', 'reports', 'crispy_chicken_report.pdf')
    pdfkit.from_file('temp_report.html', pdf_path)
    
    # Delete temporary file
    os.remove('temp_report.html')
    
    flash('PDF report generated successfully', 'success')
    return send_file(pdf_path, as_attachment=True)

# API to get real-time sales data
@app.route('/api/sales-data')
@login_required
def api_sales_data():
    # Convert data to JSON
    daily_sales = df.groupby('Date')['Sales (AED)'].sum().reset_index()
    daily_sales['Date'] = daily_sales['Date'].dt.strftime('%Y-%m-%d')
    
    return jsonify(daily_sales.to_dict('records'))

# Create basic templates
with open('templates/base.html', 'w', encoding='utf-8') as f:
    f.write('''
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crispy Chicken Restaurant Data Analysis System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: none;
            border-radius: 10px;
        }
        .card-header {
            font-weight: bold;
            background-color: #4F81BD;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 12px 20px;
        }
        .table {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .chart-container {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stats-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .stats-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0d6efd;
            margin-bottom: 10px;
        }
        .stats-label {
            color: #6c757d;
            font-size: 1.1rem;
        }
        .btn-primary {
            background-color: #4F81BD;
            border-color: #4F81BD;
        }
        .btn-primary:hover {
            background-color: #3A6BA5;
            border-color: #3A6BA5;
        }
        .navbar {
            background-color: #4F81BD !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .navbar-nav .nav-link {
            color: rgba(255,255,255,.8);
            font-weight: 500;
            margin: 0 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .navbar-nav .nav-link:hover, .navbar-nav .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,.1);
        }
        .footer {
            background-color: #343a40;
            color: white;
            padding: 20px 0;
            margin-top: 40px;
        }
        .alert {
            border-radius: 8px;
            border: none;
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .badge {
            font-size: 0.9em;
        }
        .user-info {
            color: white;
            margin-left: 10px;
        }
        .dropdown-menu {
            left: auto;
            right: 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="bi bi-shop"></i> Crispy Chicken - Data Analysis
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="bi bi-house-door"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('analysis') }}">
                            <i class="bi bi-graph-up"></i> Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('data_management') }}">
                            <i class="bi bi-database"></i> Data Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('report') }}">
                            <i class="bi bi-file-earmark-text"></i> Management Report
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('targets') }}">
                            <i class="bi bi-bullseye"></i> Target Plan
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-bar-chart-line"></i> Advanced Analytics
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('branch_comparison') }}">Branch Comparison</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('daily_sales') }}">Daily Sales</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('delivery_analysis') }}">Delivery Analysis</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('sales_forecast') }}">Sales Forecast</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('generate_pdf_report') }}">PDF Report</a></li>
                        </ul>
                    </li>
                    {% if session.get('role') == 'admin' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('target_management') }}">
                            <i class="bi bi-gear"></i> Target Management
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> <span class="user-info">{{ session.get('name', '') }}</span>
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </div>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Crispy Chicken Restaurant Data Analysis System</h5>
                    <p>Comprehensive system for sales data analysis and performance management</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>Â© 2025 All Rights Reserved</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {% block scripts %}{% endblock %}
</body>
</html>
    ''')

with open('templates/login.html', 'w', encoding='utf-8') as f:
    f.write('''
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Crispy Chicken Restaurant Data Analysis System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-header h1 {
            color: #4F81BD;
            font-weight: bold;
        }
        .login-header p {
            color: #6c757d;
        }
        .form-control {
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .btn-primary {
            background-color: #4F81BD;
            border-color: #4F81BD;
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            font-weight: bold;
        }
        .btn-primary:hover {
            background-color: #3A6BA5;
            border-color: #3A6BA5;
        }
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo i {
            font-size: 3rem;
            color: #4F81BD;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <i class="bi bi-shop"></i>
        </div>
        <div class="login-header">
            <h1>Login</h1>
            <p>Crispy Chicken Restaurant Data Analysis System</p>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <form method="POST">
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                    <input type="text" class="form-control" id="username" name="username" required>
                </div>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-lock"></i></span>
                    <input type="password" class="form-control" id="password" name="password" required>
                </div>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="rememberMe">
                <label class="form-check-label" for="rememberMe">
                    Remember me
                </label>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
        </form>
        
        <div class="mt-4 text-center text-muted">
            <p>Default credentials: admin / admin123</p>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
    ''')

with open('templates/index.html', 'w', encoding='utf-8') as f:
    f.write('''
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-4">Crispy Chicken Restaurant Dashboard</h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ "%.2f"|format(total_sales) }}</div>
            <div class="stats-label">Total Sales (AED)</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ total_transactions }}</div>
            <div class="stats-label">Total Transactions</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ "%.2f"|format(avg_sales_per_transaction) }}</div>
            <div class="stats-label">Avg Sales per Transaction</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ best_restaurant }}</div>
            <div class="stats-label">Best Restaurant</div>
            <div class="text-success"><i class="bi bi-arrow-up"></i> {{ "%.2f"|format(best_restaurant_sales) }} AED</div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ best_day }}</div>
            <div class="stats-label">Best Day</div>
            <div class="text-success"><i class="bi bi-arrow-up"></i> {{ "%.2f"|format(best_day_sales) }} AED</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ worst_restaurant }}</div>
            <div class="stats-label">Worst Restaurant</div>
            <div class="text-danger"><i class="bi bi-arrow-down"></i> {{ "%.2f"|format(worst_restaurant_sales) }} AED</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ worst_day }}</div>
            <div class="stats-label">Worst Day</div>
            <div class="text-danger"><i class="bi bi-arrow-down"></i> {{ "%.2f"|format(worst_day_sales) }} AED</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ df.shape[0] }}</div>
            <div class="stats-label">Number of Records</div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <span>Daily Sales (Real-time Updates)</span>
            <div>
                <button id="refresh-btn" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <canvas id="dailySalesChart" height="100"></canvas>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Sales Data</span>
        <a href="{{ url_for('download') }}" class="btn btn-success btn-sm">
            <i class="bi bi-download"></i> Download Data
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            {{ table|safe }}
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-3">
        <a href="{{ url_for('analysis') }}" class="btn btn-primary w-100 mb-2">
            <i class="bi bi-graph-up"></i> View Detailed Analytics
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('report') }}" class="btn btn-info w-100 mb-2">
            <i class="bi bi-file-earmark-text"></i> Management Report
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('targets') }}" class="btn btn-warning w-100 mb-2">
            <i class="bi bi-bullseye"></i> Target Plan
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('generate_pdf_report') }}" class="btn btn-danger w-100 mb-2">
            <i class="bi bi-file-pdf"></i> PDF Report
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Setup daily sales chart
        const ctx = document.getElementById('dailySalesChart').getContext('2d');
        const dailySalesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ daily_sales|map(attribute='Date')|list|tojson }},
                datasets: [{
                    label: 'Sales (AED)',
                    data: {{ daily_sales|map(attribute='Sales (AED)')|list|tojson }},
                    backgroundColor: 'rgba(79, 129, 189, 0.2)',
                    borderColor: 'rgba(79, 129, 189, 1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + ' AED';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Real-time data refresh
        document.getElementById('refresh-btn').addEventListener('click', function() {
            fetch('/api/sales-data')
                .then(response => response.json())
                .then(data => {
                    dailySalesChart.data.labels = data.map(item => item.Date);
                    dailySalesChart.data.datasets[0].data = data.map(item => item['Sales (AED)']);
                    dailySalesChart.update();
                })
                .catch(error => console.error('Error fetching data:', error));
        });
        
        // Auto refresh every 30 seconds
        setInterval(function() {
            fetch('/api/sales-data')
                .then(response => response.json())
                .then(data => {
                    dailySalesChart.data.labels = data.map(item => item.Date);
                    dailySalesChart.data.datasets[0].data = data.map(item => item['Sales (AED)']);
                    dailySalesChart.update();
                })
                .catch(error => console.error('Error fetching data:', error));
        }, 30000);
    });
</script>
{% endblock %}
    ''')

# Create remaining templates
with open('templates/analysis.html', 'w', encoding='utf-8') as f:
    f.write('''
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-4">Detailed Analytics</h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Branch Sales (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ branch_sales|safe }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Branch Transactions</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ branch_transactions|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Average Branch Sales (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ branch_avg_sales|safe }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Day Sales (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ day_sales|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Day Transactions</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ day_transactions|safe }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Weekly Sales (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ week_sales|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Monthly Sales (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ month_sales|safe }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Delivery Analysis</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="stats-value">{{ "%.2f"|format(delivery_sales) }}</div>
                            <div class="stats-label">Delivery Sales (AED)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="stats-value">{{ delivery_transactions }}</div>
                            <div class="stats-label">Delivery Transactions</div>
                        </div>
                    </div>
                </div>
                <div class="stats-card mt-3">
                    <div class="stats-value">{{ "%.2f"|format(delivery_avg) }}</div>
                    <div class="stats-label">Avg Delivery Sales per Transaction</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h4 class="text-center">Branch Sales (AED)</h4>
            <img src="data:image/png;base64,{{ branch_sales_img }}" class="img-fluid">
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h4 class="text-center">Day Sales (AED)</h4>
            <img src="data:image/png;base64,{{ day_sales_img }}" class="img-fluid">
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h4 class="text-center">Branch Sales Comparison by Day (AED)</h4>
            <img src="data:image/png;base64,{{ heatmap_img }}" class="img-fluid">
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h4 class="text-center">Weekly Sales (AED)</h4>
            <img src="data:image/png;base64,{{ week_sales_img }}" class="img-fluid">
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h4 class="text-center">Monthly Sales Distribution (%)</h4>
            <img src="data:image/png;base64,{{ month_sales_img }}" class="img-fluid">
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
    ''')

# Create remaining templates
with open('templates/data.html', 'w', encoding='utf-8') as f:
    f.write('''
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-4">Data Management</h1>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Upload Data from Excel File</div>
    <div class="card-body">
        <form action="{{ url_for('data_management') }}" method="POST" enctype="multipart/form-data">
            <div class="row">
                <div class="col-md-9 mb-3">
                    <input type="file" class="form-control" id="file" name="file" accept=".xlsx, .xls" required>
                </div>
                <div class="col-md-3 mb-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-upload"></i> Upload Data
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Add New Data</div>
    <div class="card-body">
        <form action="{{ url_for('add_data') }}" method="POST">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="date" class="form-label">Date</label>
                    <input type="date" class="form-control" id="date" name="date" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="branch" class="form-label">Branch</label>
                    <select class="form-select" id="branch" name="branch" required>
                        <option value="" selected disabled>Select Branch</option>
                        {% for branch in branches %}
                        <option value="{{ branch }}">{{ branch }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="transactions" class="form-label">Transactions</label>
                    <input type="number" class="form-control" id="transactions" name="transactions" min="0" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="sales" class="form-label">Sales (AED)</label>
                    <input type="number" class="form-control" id="sales" name="sales" min="0" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add Data
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Filter Data</div>
    <div class="card-body">
        <form method="GET">
            <div class="row">
                <div class="col-md-5 mb-3">
                    <label for="branch-filter" class="form-label">Branch</label>
                    <select class="form-select" id="branch-filter" name="branch">
                        <option value="">All Branches</option>
                        {% for branch in branches %}
                        <option value="{{ branch }}" {% if branch == current_branch %}selected{% endif %}>{{ branch }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-5 mb-3">
                    <label for="date-filter" class="form-label">Date</label>
                    <input type="date" class="form-control" id="date-filter" name="date" 
                           value="{{ current_date }}">
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Sales Data</span>
        <a href="{{ url_for('download') }}" class="btn btn-success btn-sm">
            <i class="bi bi-download"></i> Download Data
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Date</th>
                        <th>Branch</th>
                        <th>Channel</th>
                        <th>Transactions</th>
                        <th>Sales (AED)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in range(df.shape[0]) %}
                    <tr>
                        <td>{{ i+1 }}</td>
                        <td>{{ df.iloc[i]['Date'].strftime('%Y-%m-%d') }}</td>
                        <td>{{ df.iloc[i]['Branch'] }}</td>
                        <td>{{ df.iloc[i]['Channel'] }}</td>
                        <td>{{ df.iloc[i]['Transactions'] }}</td>
                        <td>{{ "%.2f"|format(df.iloc[i]['Sales (AED)']) }}</td>
                        <td>
                            <a href="{{ url_for('edit_data', index=i) }}" class="btn btn-sm btn-warning">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="{{ url_for('delete_data', index=i) }}" class="btn btn-sm btn-danger"
                               onclick="return confirm('Are you sure you want to delete this data?')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('data_management', page=page-1, branch=current_branch, date=current_date) }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% endif %}
                
                {% for p in range(1, total_pages+1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('data_management', page=p, branch=current_branch, date=current_date) }}">{{ p }}</a>
                </li>
                {% endfor %}
                
                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('data_management', page=page+1, branch=current_branch, date=current_date) }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
    ''')

# Create remaining templates
with open('templates/edit.html', 'w', encoding='utf-8') as f:
    f.write('''
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-4">Edit Data</h1>
    </div>
</div>

<div class="card">
    <div class="card-header">Edit Data</div>
    <div class="card-body">
        <form action="{{ url_for('edit_data', index=index) }}" method="POST">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="date" class="form-label">Date</label>
                    <input type="date" class="form-control" id="date" name="date" 
                           value="{{ row['Date'].strftime('%Y-%m-%d') }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="branch" class="form-label">Branch</label>
                    <select class="form-select" id="branch" name="branch" required>
                        {% for branch in branches %}
                        <option value="{{ branch }}" {% if branch == row['Branch'] %}selected{% endif %}>{{ branch }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="transactions" class="form-label">Transactions</label>
                    <input type="number" class="form-control" id="transactions" name="transactions" 
                           value="{{ row['Transactions'] }}" min="0" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="sales" class="form-label">Sales (AED)</label>
                    <input type="number" class="form-control" id="sales" name="sales" 
                           value="{{ row['Sales (AED)'] }}" min="0" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                    <a href="{{ url_for('data_management') }}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}
    ''')

# Create remaining templates
with open('templates/report.html', 'w', encoding='utf-8') as f:
    f.write('''
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-4">Management Report</h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ "%.2f"|format(total_sales) }}</div>
            <div class="stats-label">Total Sales (AED)</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ total_transactions }}</div>
            <div class="stats-label">Total Transactions</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ "%.2f"|format(avg_sales_per_transaction) }}</div>
            <div class="stats-label">Avg Sales per Transaction</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ best_restaurant }}</div>
            <div class="stats-label">Best Restaurant</div>
            <div class="text-success"><i class="bi bi-arrow-up"></i> {{ "%.2f"|format(best_restaurant_sales) }} AED</div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ best_day }}</div>
            <div class="stats-label">Best Day</div>
            <div class="text-success"><i class="bi bi-arrow-up"></i> {{ "%.2f"|format(best_day_sales) }} AED</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ worst_restaurant }}</div>
            <div class="stats-label">Worst Restaurant</div>
            <div class="text-danger"><i class="bi bi-arrow-down"></i> {{ "%.2f"|format(worst_restaurant_sales) }} AED</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ worst_day }}</div>
            <div class="stats-label">Worst Day</div>
            <div class="text-danger"><i class="bi bi-arrow-down"></i> {{ "%.2f"|format(worst_day_sales) }} AED</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ df.shape[0] }}</div>
            <div class="stats-label">Number of Records</div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h4 class="text-center">Branch Sales (AED)</h4>
            <img src="data:image/png;base64,{{ branch_sales_img }}" class="img-fluid">
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h4 class="text-center">Day Sales (AED)</h4>
            <img src="data:image/png;base64,{{ day_sales_img }}" class="img-fluid">
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h4 class="text-center">Branch Sales Comparison by Day (AED)</h4>
            <img src="data:image/png;base64,{{ heatmap_img }}" class="img-fluid">
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h4 class="text-center">Branch Contribution to Total Sales</h4>
            <img src="data:image/png;base64,{{ contribution_img }}" class="img-fluid">
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Average Branch Sales (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ avg_branch_sales|safe }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Average Day Sales (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ avg_day_sales|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Weekly Sales (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ weekly_sales|safe }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Monthly Sales (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ monthly_sales|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Management Recommendations</div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h5>Performance Improvement Recommendations:</h5>
                <ul>
                    <li>It is recommended to increase marketing in <strong>{{ worst_restaurant }}</strong> branch to improve its performance.</li>
                    <li><strong>{{ worst_day }}</strong> is the weakest sales day, it is recommended to run promotional offers on this day.</li>
                    <li><strong>{{ best_restaurant }}</strong> branch is the best performer, its strategies can be leveraged in other branches.</li>
                    <li><strong>{{ best_day }}</strong> is the strongest sales day, it is recommended to increase resources on this day.</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h5>Immediate Actions:</h5>
                <ul>
                    <li>Review service quality in <strong>{{ worst_restaurant }}</strong> branch.</li>
                    <li>Analyze reasons for weak sales on <strong>{{ worst_day }}</strong>.</li>
                    <li>Hold a meeting with <strong>{{ worst_restaurant }}</strong> branch team to discuss challenges.</li>
                    <li>Develop a performance improvement plan for <strong>{{ worst_restaurant }}</strong> branch.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Proposed Action Plan</div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>Responsible Party</th>
                        <th>Timeline</th>
                        <th>Success Indicators</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Improve service quality in {{ worst_restaurant }} branch</td>
                        <td>Branch Manager</td>
                        <td>Two weeks</td>
                        <td>15% increase in customer satisfaction</td>
                    </tr>
                    <tr>
                        <td>Marketing campaign to increase sales on {{ worst_day }}</td>
                        <td>Marketing Department</td>
                        <td>One month</td>
                        <td>20% increase in sales</td>
                    </tr>
                    <tr>
                        <td>Train staff on exceptional customer service</td>
                        <td>HR Department</td>
                        <td>Two months</td>
                        <td>30% reduction in complaints</td>
                    </tr>
                    <tr>
                        <td>Develop menu and add new offers</td>
                        <td>Food Department</td>
                        <td>Three months</td>
                        <td>10% increase in average order value</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <a href="{{ url_for('index') }}" class="btn btn-secondary w-100">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
    <div class="col-md-6">
        <a href="{{ url_for('targets') }}" class="btn btn-primary w-100">
            <i class="bi bi-bullseye"></i> View Target Plan
        </a>
    </div>
</div>
{% endblock %}
    ''')

# Create remaining templates
with open('templates/targets.html', 'w', encoding='utf-8') as f:
    f.write('''
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-4">Target Plan</h1>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Comparison of Current Average Sales with Targets</div>
    <div class="card-body">
        <div class="chart-container">
            <img src="data:image/png;base64,{{ targets_img }}" class="img-fluid">
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Gap Between Current Sales and Targets</div>
    <div class="card-body">
        <div class="chart-container">
            <img src="data:image/png;base64,{{ gap_img }}" class="img-fluid">
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Target Details</div>
    <div class="card-body">
        <div class="table-responsive">
            {{ targets_table|safe }}
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Required Gap to Achieve Targets</div>
    <div class="card-body">
        <div class="table-responsive">
            {{ gap_table|safe }}
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Strategies to Achieve Targets</div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h5>Short-term Strategies (1-3 months):</h5>
                <ul>
                    <li>Improve service quality in all branches to increase customer satisfaction.</li>
                    <li>Develop targeted marketing campaigns to increase brand awareness.</li>
                    <li>Train staff on providing exceptional customer service.</li>
                    <li>Improve delivery operations to ensure fast and high-quality order delivery.</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h5>Long-term Strategies (3-12 months):</h5>
                <ul>
                    <li>Develop menu and add attractive promotional offers.</li>
                    <li>Open new branches in high-growth areas.</li>
                    <li>Develop mobile app to improve customer experience.</li>
                    <li>Build strategic partnerships with food delivery platforms.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Implementation Timeline</div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Phase</th>
                        <th>Timeline</th>
                        <th>Actions</th>
                        <th>Responsible</th>
                        <th>Success Indicators</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Planning</td>
                        <td>First week</td>
                        <td>Analyze gaps and set priorities</td>
                        <td>Development Manager</td>
                        <td>Clear action plan with defined targets</td>
                    </tr>
                    <tr>
                        <td>Development</td>
                        <td>Week 2-4</td>
                        <td>Implement training programs and improve operations</td>
                        <td>Operations Manager</td>
                        <td>90% of staff training completed</td>
                    </tr>
                    <tr>
                        <td>Marketing</td>
                        <td>Week 3-6</td>
                        <td>Launch marketing campaigns and promotional offers</td>
                        <td>Marketing Manager</td>
                        <td>25% increase in brand awareness</td>
                    </tr>
                    <tr>
                        <td>Follow-up</td>
                        <td>Ongoing</td>
                        <td>Monitor performance and make necessary adjustments</td>
                        <td>Quality Manager</td>
                        <td>Achievement of defined targets</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Required Resource Allocation</div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h5>Human Resources:</h5>
                <ul>
                    <li>Train 5 staff members from each branch on customer service.</li>
                    <li>Hire 3 marketing managers for new campaigns.</li>
                    <li>Hire 2 data analysts to monitor performance.</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h5>Financial Resources:</h5>
                <ul>
                    <li>Marketing budget: 100,000 AED.</li>
                    <li>Training budget: 50,000 AED.</li>
                    <li>Operations improvement budget: 75,000 AED.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <a href="{{ url_for('index') }}" class="btn btn-secondary w-100">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
    <div class="col-md-6">
        <a href="{{ url_for('report') }}" class="btn btn-info w-100">
            <i class="bi bi-file-earmark-text"></i> Management Report
        </a>
    </div>
</div>
{% endblock %}
    ''')

# Create remaining templates
with open('templates/branch_comparison.html', 'w', encoding='utf-8') as f:
    f.write('''
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-4">Branch Performance Comparison</h1>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Comprehensive Branch Performance Comparison</div>
    <div class="card-body">
        <div class="chart-container">
            <img src="data:image/png;base64,{{ comparison_img }}" class="img-fluid">
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Branch Sales (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ branch_sales|safe }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Branch Transactions</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ branch_transactions|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Average Branch Sales (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ branch_avg_sales|safe }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Average Branch Transactions</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ branch_avg_transactions|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Performance Analysis</div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <h5>Best Performing Branches:</h5>
                <ul>
                    <li>Highest sales: {{ branch_sales.index[0] }} with sales of {{ "%.2f"|format(branch_sales[0]) }} AED</li>
                    <li>Highest transactions: {{ branch_transactions.index[0] }} with {{ branch_transactions[0] }} transactions</li>
                    <li>Highest average sales: {{ branch_avg_sales.index[0] }} with average of {{ "%.2f"|format(branch_avg_sales[0]) }} AED</li>
                </ul>
                
                <h5 class="mt-4">Weakest Performing Branches:</h5>
                <ul>
                    <li>Lowest sales: {{ branch_sales.index[-1] }} with sales of {{ "%.2f"|format(branch_sales[-1]) }} AED</li>
                    <li>Lowest transactions: {{ branch_transactions.index[-1] }} with {{ branch_transactions[-1] }} transactions</li>
                    <li>Lowest average sales: {{ branch_avg_sales.index[-1] }} with average of {{ "%.2f"|format(branch_avg_sales[-1]) }} AED</li>
                </ul>
                
                <h5 class="mt-4">Recommendations:</h5>
                <ul>
                    <li>Study the reasons for {{ branch_sales.index[0] }} branch's success and apply it to other branches.</li>
                    <li>Develop a performance improvement plan for {{ branch_sales.index[-1] }} branch.</li>
                    <li>Analyze factors affecting average sales in each branch.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
    ''')

# Create remaining templates
with open('templates/daily_sales.html', 'w', encoding='utf-8') as f:
    f.write('''
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-4">Daily Sales Tracking</h1>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Daily Sales Trends</div>
    <div class="card-body">
        <div class="chart-container">
            <img src="data:image/png;base64,{{ daily_sales_img }}" class="img-fluid">
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Daily Sales (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ daily_sales|safe }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Daily Transactions</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ daily_transactions|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Daily Sales Analysis</div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <h5>Best Sales Days:</h5>
                <ul>
                    {% for i in range(min(3, daily_sales.shape[0])) %}
                    <li>{{ daily_sales.iloc[i]['Date'] }}: {{ "%.2f"|format(daily_sales.iloc[i]['Sales (AED)']) }} AED</li>
                    {% endfor %}
                </ul>
                
                <h5 class="mt-4">Worst Sales Days:</h5>
                <ul>
                    {% for i in range(max(0, daily_sales.shape[0]-3), daily_sales.shape[0]) %}
                    <li>{{ daily_sales.iloc[i]['Date'] }}: {{ "%.2f"|format(daily_sales.iloc[i]['Sales (AED)']) }} AED</li>
                    {% endfor %}
                </ul>
                
                <h5 class="mt-4">Average Daily Sales:</h5>
                <p>{{ "%.2f"|format(daily_sales['Sales (AED)'].mean()) }} AED</p>
                
                <h5 class="mt-4">Recommendations:</h5>
                <ul>
                    <li>Analyze reasons for high sales on excellent days.</li>
                    <li>Study factors affecting low sales on weak days.</li>
                    <li>Develop strategies to increase sales on low-performance days.</li>
                    <li>Plan resources based on daily sales patterns.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
    ''')

# Create remaining templates
with open('templates/delivery_analysis.html', 'w', encoding='utf-8') as f:
    f.write('''
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-4">Delivery Analysis</h1>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Comprehensive Delivery Analysis</div>
    <div class="card-body">
        <div class="chart-container">
            <img src="data:image/png;base64,{{ delivery_img }}" class="img-fluid">
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Delivery Sales by Branch (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ delivery_branch_sales|safe }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Delivery Transactions by Branch</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ delivery_branch_transactions|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Average Delivery Sales by Branch (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ delivery_branch_avg_sales|safe }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Delivery Sales by Day (AED)</div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ delivery_day_sales|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Delivery Performance Analysis</div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <h5>Best Delivery Performing Branches:</h5>
                <ul>
                    <li>Highest delivery sales: {{ delivery_branch_sales.index[0] }} with sales of {{ "%.2f"|format(delivery_branch_sales[0]) }} AED</li>
                    <li>Highest delivery transactions: {{ delivery_branch_transactions.index[0] }} with {{ delivery_branch_transactions[0] }} transactions</li>
                    <li>Highest average delivery sales: {{ delivery_branch_avg_sales.index[0] }} with average of {{ "%.2f"|format(delivery_branch_avg_sales[0]) }} AED</li>
                </ul>
                
                <h5 class="mt-4">Best Delivery Days:</h5>
                <ul>
                    <li>Highest delivery sales: {{ delivery_day_sales.index[0] }} with sales of {{ "%.2f"|format(delivery_day_sales[0]) }} AED</li>
                    <li>Highest delivery transactions: {{ delivery_day_transactions.index[0] }} with {{ delivery_day_transactions[0] }} transactions</li>
                </ul>
                
                <h5 class="mt-4">Recommendations to Improve Delivery Performance:</h5>
                <ul>
                    <li>Improve delivery speed in low-performing branches.</li>
                    <li>Increase number of delivery drivers on high-demand days.</li>
                    <li>Develop order tracking system to improve customer experience.</li>
                    <li>Offer special deals on delivery orders to increase sales.</li>
                    <li>Analyze delivery costs and improve profit margins.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
    ''')

# Create remaining templates
with open('templates/sales_forecast.html', 'w', encoding='utf-8') as f:
    f.write('''
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-4">Sales Forecast</h1>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Sales Forecast for Next 7 Days</div>
    <div class="card-body">
        <div class="chart-container">
            <img src="data:image/png;base64,{{ forecast_img }}" class="img-fluid">
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Forecast Details</div>
    <div class="card-body">
        <div class="table-responsive">
            {{ forecast_table|safe }}
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Forecast Analysis</div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <h5>Expected Average Sales:</h5>
                <p>{{ "%.2f"|format(forecast_table['Forecasted Sales (AED)'].mean()) }} AED daily</p>
                
                <h5 class="mt-4">Highest Forecasted Sales Day:</h5>
                <p>{{ forecast_table.loc[forecast_table['Forecasted Sales (AED)'].idxmax(), 'Date'] }}: {{ "%.2f"|format(forecast_table['Forecasted Sales (AED)'].max()) }} AED</p>
                
                <h5 class="mt-4">Lowest Forecasted Sales Day:</h5>
                <p>{{ forecast_table.loc[forecast_table['Forecasted Sales (AED)'].idxmin(), 'Date'] }}: {{ "%.2f"|format(forecast_table['Forecasted Sales (AED)'].min()) }} AED</p>
                
                <h5 class="mt-4">Recommendations Based on Forecasts:</h5>
                <ul>
                    <li>Plan resources and staff based on forecasted sales.</li>
                    <li>Prepare inventory to accommodate expected sales increase.</li>
                    <li>Develop promotional offers for days with low forecasted sales.</li>
                    <li>Monitor actual performance against forecasts and adjust strategies as needed.</li>
                    <li>Update forecasts regularly based on new data.</li>
                </ul>
                
                <h5 class="mt-4">Notes:</h5>
                <p>Forecasts are based on historical data and current trends, and may be affected by external factors not included in the model such as special events, seasonal changes, or competition.</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
    ''')

# Create remaining templates
with open('templates/target_management.html', 'w', encoding='utf-8') as f:
    f.write('''
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-4">Target Management</h1>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Add New Target</div>
    <div class="card-body">
        <form action="{{ url_for('target_management') }}" method="POST">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="branch" class="form-label">Branch</label>
                    <select class="form-select" id="branch" name="branch" required>
                        <option value="" selected disabled>Select Branch</option>
                        {% for branch in branches %}
                        <option value="{{ branch }}">{{ branch }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="target_value" class="form-label">Target Value</label>
                    <input type="number" class="form-control" id="target_value" name="target_value" step="0.01" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="target_type" class="form-label">Target Type</label>
                    <select class="form-select" id="target_type" name="target_type" required>
                        <option value="" selected disabled>Select Type</option>
                        <option value="Sales">Sales</option>
                        <option value="Transactions">Transactions</option>
                        <option value="Average Sales">Average Sales</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="period" class="form-label">Period</label>
                    <select class="form-select" id="period" name="period" required>
                        <option value="" selected disabled>Select Period</option>
                        <option value="Daily">Daily</option>
                        <option value="Weekly">Weekly</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Yearly">Yearly</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add Target
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">Current Targets</div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Branch</th>
                        <th>Target Value</th>
                        <th>Target Type</th>
                        <th>Period</th>
                        <th>Creation Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for target in targets %}
                    <tr>
                        <td>{{ target[0] }}</td>
                        <td>{{ target[1] }}</td>
                        <td>{{ "%.2f"|format(target[2]) }}</td>
                        <td>{{ target[3] }}</td>
                        <td>{{ target[4] }}</td>
                        <td>{{ target[5] }}</td>
                        <td>
                            <a href="{{ url_for('delete_target', target_id=target[0]) }}" class="btn btn-sm btn-danger"
                               onclick="return confirm('Are you sure you want to delete this target?')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
    ''')

# Run the app
if __name__ == '__main__':
    app.run(debug=True)
